<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat Widget</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        heading: ['Poppins', 'sans-serif'],
                        body: ['Inter', 'sans-serif']
                    },
                    colors: {
                        lavender: {
                            50: '#F8F5FA',
                            100: '#F0EBF5',
                            200: '#E0D6EB',
                            300: '#D0C1E1',
                            400: '#C0ACD7',
                            500: '#a06c9e',
                            600: '#804f7e',
                            700: '#60325e',
                            800: '#40153e',
                            900: '#20001e',
                        },
                        plum: {
                            50: '#F5F0F5',
                            100: '#EBE0EB',
                            200: '#D7C0D7',
                            300: '#C3A0C3',
                            400: '#AF80AF',
                            500: '#4b2840',
                            600: '#673f68',
                            700: '#4A2D4B',
                            800: '#2E1B2E',
                            900: '#120912',
                        },
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body class="font-body">
    <!-- Chat Widget Button -->
    <div id="chat-widget-button" class="fixed bottom-6 right-6 z-50">
        <button class="w-16 h-16 bg-plum-500 hover:bg-plum-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center group">
            <i class="fas fa-comments text-xl group-hover:scale-110 transition-transform"></i>
        </button>
        <div id="unread-indicator" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white text-xs rounded-full flex items-center justify-center hidden">0</div>
    </div>

    <!-- Chat Widget Window -->
    <div id="chat-widget-window" class="fixed bottom-24 right-6 w-80 h-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-50 hidden">
        <!-- Chat Header -->
        <div class="bg-plum-500 text-white p-4 rounded-t-lg flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-sm"></i>
                </div>
                <div>
                    <h3 class="font-heading font-bold text-sm">Make Up By Kyleen</h3>
                    <p class="text-xs opacity-80">We're here to help!</p>
                </div>
            </div>
            <button id="close-chat" class="text-white hover:text-gray-200 transition">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 p-4 h-64 overflow-y-auto bg-gray-50">
            <div class="flex items-center justify-center h-full text-gray-500">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading messages...</p>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center gap-2">
                <input type="text" id="user-message-input" placeholder="Type your message..." 
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-plum-500 focus:border-plum-500">
                <button id="send-user-message" class="w-8 h-8 bg-plum-500 text-white rounded-full hover:bg-plum-600 transition flex items-center justify-center">
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="px-4 pb-4">
            <div class="flex flex-wrap gap-2">
                <button class="quick-action px-3 py-1 bg-lavender-100 text-plum-700 text-xs rounded-full hover:bg-lavender-200 transition">
                    Book Appointment
                </button>
                <button class="quick-action px-3 py-1 bg-lavender-100 text-plum-700 text-xs rounded-full hover:bg-lavender-200 transition">
                    View Packages
                </button>
                <button class="quick-action px-3 py-1 bg-lavender-100 text-plum-700 text-xs rounded-full hover:bg-lavender-200 transition">
                    Contact Info
                </button>
            </div>
        </div>
    </div>

    <!-- Login Required Message -->
    <div id="login-required" class="fixed bottom-24 right-6 w-80 bg-white rounded-lg shadow-2xl border border-gray-200 z-50 hidden p-4">
        <div class="text-center">
            <i class="fas fa-lock text-plum-500 text-2xl mb-2"></i>
            <h3 class="font-heading font-bold text-plum-700 mb-2">Login Required</h3>
            <p class="text-gray-600 text-sm mb-3">Please log in to start a chat with our support team.</p>
            <a href="login.php" class="bg-plum-500 text-white px-4 py-2 rounded-lg hover:bg-plum-600 transition text-sm">
                Login Now
            </a>
        </div>
    </div>

    <script>
        class UserChatWidget {
            constructor() {
                this.isOpen = false;
                this.messages = [];
                this.isLoggedIn = false;
                this.init();
            }

            async init() {
                await this.checkLoginStatus();
                this.setupEventListeners();
                
                if (this.isLoggedIn) {
                    this.loadMessages();
                    this.updateUnreadCount();
                    
                    // Poll for new messages every 5 seconds
                    setInterval(() => {
                        this.loadMessages();
                        this.updateUnreadCount();
                    }, 5000);
                }
            }

            async checkLoginStatus() {
                try {
                    const response = await fetch('api/chat_api.php?action=check_auth');
                    if (response.ok) {
                        const data = await response.json();
                        this.isLoggedIn = data.authenticated || false;
                    } else {
                        this.isLoggedIn = false;
                    }
                } catch (error) {
                    console.error('Error checking login status:', error);
                    this.isLoggedIn = false;
                }
            }

            async loadMessages() {
                if (!this.isLoggedIn) return;
                
                try {
                    const response = await fetch('api/chat_api.php?action=messages&other_user_id=1');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.messages = data.messages;
                            this.renderMessages();
                        }
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }

            setupEventListeners() {
                const button = document.getElementById('chat-widget-button');
                const window = document.getElementById('chat-widget-window');
                const closeBtn = document.getElementById('close-chat');
                const messageInput = document.getElementById('user-message-input');
                const sendBtn = document.getElementById('send-user-message');
                const loginRequired = document.getElementById('login-required');

                button.onclick = () => {
                    if (!this.isLoggedIn) {
                        // Show login required message
                        loginRequired.classList.remove('hidden');
                        setTimeout(() => {
                            loginRequired.classList.add('hidden');
                        }, 3000);
                    } else {
                        this.toggleChat();
                    }
                };
                
                closeBtn.onclick = () => this.closeChat();

                const sendMessage = async () => {
                    const message = messageInput.value.trim();
                    if (message && this.isLoggedIn) {
                        try {
                            const response = await fetch('api/chat_api.php?action=send_message', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    receiver_id: 1, // Admin user ID
                                    message: message
                                })
                            });

                            if (response.ok) {
                                const result = await response.json();
                                if (result.success) {
                                    messageInput.value = '';
                                    this.loadMessages();
                                } else {
                                    console.error('Failed to send message:', result.error);
                                }
                            }
                        } catch (error) {
                            console.error('Error sending message:', error);
                        }
                    }
                };

                sendBtn.onclick = sendMessage;
                messageInput.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                };

                // Quick actions
                document.querySelectorAll('.quick-action').forEach(btn => {
                    btn.onclick = () => {
                        if (this.isLoggedIn) {
                            const action = btn.textContent.trim();
                            messageInput.value = `I'm interested in: ${action}`;
                            sendMessage();
                        }
                    };
                });
            }

            toggleChat() {
                const window = document.getElementById('chat-widget-window');
                if (this.isOpen) {
                    this.closeChat();
                } else {
                    this.openChat();
                }
            }

            async openChat() {
                const window = document.getElementById('chat-widget-window');
                window.classList.remove('hidden');
                this.isOpen = true;
                
                // Mark messages as read
                if (this.isLoggedIn) {
                    await this.markMessagesAsRead();
                    this.updateUnreadCount();
                }
            }

            closeChat() {
                const window = document.getElementById('chat-widget-window');
                window.classList.add('hidden');
                this.isOpen = false;
            }

            async markMessagesAsRead() {
                try {
                    await fetch('api/chat_api.php?action=mark_read', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            other_user_id: 1 // Admin user ID
                        })
                    });
                } catch (error) {
                    console.error('Error marking messages as read:', error);
                }
            }

            renderMessages() {
                const container = document.getElementById('chat-messages');
                
                if (this.messages.length === 0) {
                    container.innerHTML = `
                        <div class="mb-4">
                            <div class="flex justify-start">
                                <div class="max-w-xs bg-white text-gray-800 px-3 py-2 rounded-lg border border-gray-200">
                                    <p class="text-sm">Hi! Welcome to Make Up By Kyleen. How can I help you today?</p>
                                    <p class="text-xs text-gray-500 mt-1">Just now</p>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';

                this.messages.forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'mb-4';
                    
                    messageElement.innerHTML = `
                        <div class="flex ${msg.sender_id == 1 ? 'justify-start' : 'justify-end'}">
                            <div class="max-w-xs px-3 py-2 rounded-lg ${
                                msg.sender_id != 1
                                    ? 'bg-plum-500 text-white' 
                                    : 'bg-white text-gray-800 border border-gray-200'
                            }">
                                <p class="text-sm">${this.escapeHtml(msg.message)}</p>
                                <p class="text-xs mt-1 ${
                                    msg.sender_id != 1 ? 'text-plum-100' : 'text-gray-500'
                                }">${this.formatTime(msg.created_at)}</p>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(messageElement);
                });

                container.scrollTop = container.scrollHeight;
            }

            async updateUnreadCount() {
                if (!this.isLoggedIn) return;
                
                try {
                    const response = await fetch('api/chat_api.php?action=unread_count');
                    if (response.ok) {
                        const result = await response.json();
                        const indicator = document.getElementById('unread-indicator');
                        
                        if (result.success && result.unread_count > 0 && !this.isOpen) {
                            indicator.textContent = result.unread_count;
                            indicator.classList.remove('hidden');
                        } else {
                            indicator.classList.add('hidden');
                        }
                    }
                } catch (error) {
                    console.error('Error updating unread count:', error);
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatTime(timestamp) {
                if (!timestamp) return '';
                
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
        }

        // Initialize chat widget
        document.addEventListener('DOMContentLoaded', () => {
            new UserChatWidget();
        });
    </script>
</body>
</html>
